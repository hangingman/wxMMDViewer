# MMDモデル インポート機能仕様

## 1. 概要

ユーザーが指定したPMDファイルを、アプリケーション管理下のディレクトリ（`~/.wxmmd/model/`）へ、依存ファイル（テクスチャ等）を含めて取り込む（インポートする）機能。
これにより、元ファイルの移動や削除によるリンク切れを防ぎ、安定したモデル表示を実現する。

## 2. ディレクトリ構成

インポート実行時に以下の構造でディレクトリを作成し、ファイルを格納する。

* **ルートディレクトリ:** `~/.wxmmd/`
* **モデル格納先:** `~/.wxmmd/model/<モデル名>/`
    * `<モデル名>` はPMDファイル名（拡張子なし）とする。
    * 同名のフォルダが既に存在する場合は、末尾に連番を振って重複を回避する（例: `Miku_1`）。

### 格納後のイメージ
```text
~/.wxmmd/
  └── model/
       └── HatsuneMiku/
            ├── HatsuneMiku.pmd
            ├── tex/
            │    ├── body.bmp
            │    └── face.bmp
            └── toon/
                 └── toon01.bmp
```

## 3. 処理フロー

### 3.1 ファイル選択と解析 (Phase 1)
1. メニュー「ファイル > モデルをインポート...」から起動。
2. `wxFileDialog` で `.pmd` ファイルを選択。
3. `MMDImporter::AnalyzePMD` によりPMDを解析し、使用されているテクスチャリストを抽出。
    * 同一テクスチャの重複排除。
    * スフィアマップ（`*`区切り）の分割抽出。
    * Shift-JISからUTF-8への文字コード変換。

### 3.2 依存関係解決 (Phase 2)
1. `ImportDialog` を表示。
2. テクスチャの状態（✅ OK / ⚠️ Missing）を表示。
    * 初期状態でPMDからの相対パスで自動検出を試みる。
3. 不足しているファイルについて、ユーザーが手動で「参照...」ボタンからパスを指定。
4. 全てのテクスチャの状態が「✅ OK」になるまで「インポート実行」ボタンを無効化。

### 3.3 インポート実行 (Phase 3)
1. 保存先ディレクトリの作成。
2. PMDファイルのコピー。
3. テクスチャのコピー。
    * `tex/body.bmp` のように階層構造がある場合、保存先ディレクトリ内にも同様のディレクトリ構造を再現して配置する。
4. インポート完了後、新しく配置されたPMDファイルを自動で読み込み表示する。

## 4. 実装詳細

### 主要クラス
- **`MMDImporter`**: 解析およびコピーのロジックを集約。
- **`ImportDialog`**: 依存関係解決のためのUI。
- **`clsPMDFile` (拡張)**: `GetTexturePaths()` メソッドによるテクスチャ情報の抽出。
- **文字コード変換**: `iconv` を使用し、Shift-JISのPMD内部情報をUTF-8に変換して処理。

### 制限事項・特記事項
- **ケースインセンティブ検索**: Linux環境においても、PMD内部のリソース名と実ファイル名の大文字小文字が異なる場合に対応するため、ディレクトリ階層を含めて解決を試みるロジックを実装。
- パス区切り文字はWindows形式（`\`）とUNIX形式（`/`）の両方に対応。
- スフィアマップ（`texture.bmp*sphere.sph`）は個別のファイルとして適切に処理される。
